
  <!-- Horizontal Form -->
  <div>
    <!-- form start -->
    <form id="form_loadbalance" data-pjax action="{{ reverse_url('apply.service.loadbalance.add' )}}?pro_id={{ pro_info_res.data.id }}&active=tab_2" class="form-horizontal" method="POST">
    {{ handler.xsrf_form_html() }}
    {% set applies = pro_info_res.data.pro_resource_applies %}
    {% if applies|length > 0 %}
      {% set last_apply = applies[-1] %}
    {% else %}
      {% set last_apply = None %}
    {% endif %}
    <input type="hidden" name="pro_id" value="{{ pro_info_res.data.id }}">
    {% if last_apply %}
    <input type="hidden" name="res_apply_id" value="{{ last_apply.id }}">
    {% endif %}
      <div class="box-body">
        <!-- form input -->
        <input type="hidden" id="members" name="members" value="">
        <!--div class="form-group">
          <label for="disk" class="col-sm-2 control-label">成员A</label>
          <div class="col-sm-6 input-group">
            <div class="input-group-unit">IP</div>
            <input type="text" class="form-control" name="address" placeholder="10">
            <div class="input-group-unit">PORT</div>
            <input type="text" class="form-control" name="port" placeholder="10">
          </div>
        </div-->
        {% if last_apply %}
        {% set loadbalance = last_apply.loadbalance %}
        <div class="form-group" id="member_add_button">
          <!-- button -->
          <label class="col-sm-2 control-label">
            <button type="button" onclick="add_member()" class="btn btn-info btn-sm"><i class="fa fa-plus"></i> 添加成员</button>
          </label>
          <div class="col-sm-6 input-group">
          <div class="input-group-unit" id="members_add_tip">还可以添加{{ loadbalance }}个成员</div>
          </div>
        </div>
        {% endif %}
        <!--div class="form-group">
          <label for="disk" class="col-sm-2 control-label">成员B</label>
          <div class="col-sm-6 input-group">
            <div class="input-group-unit">IP</div>
            <input type="text" class="form-control" id="disk" placeholder="10">
            <div class="input-group-unit">PORT</div>
            <input type="text" class="form-control" id="disk_backup" placeholder="10">
          </div>
        </div-->
        <div class="form-group">
          <label for="loadbalance" class="col-sm-2 control-label">策略</label>
          <div class="col-sm-6 input-group">
            <select class="form-control" name="plot">
              <option value="0">轮询</option>
              <option value="1">最小连接数</option>
              <option value="2">主从</option>
              <option value="9">其他</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="loadbalance" class="col-sm-2 control-label">健康检查</label>
          <div class="col-sm-6 input-group">
            <select class="form-control" name="health">
              <option value="0">HTTP</option>
              <option value="1">TCP</option>
              <option value="2">ICMP</option>
              <option value="9">其他</option>
            </select>
            <div class="input-group-unit">
              URL:
            </div>
            <input type="text" class="form-control" id="url" name="url" placeholder="10">
            <div class="input-group-unit">
              关键字:
            </div>
            <input type="text" class="form-control" id="keyword" name="keyword" placeholder="10">
          </div>
        </div>
        <div class="form-group">
          <label for="desc" class="col-sm-2 control-label">特殊说明</label>
          <div class="col-sm-8 input-group">
            <textarea class="textarea" style="width: 100%; height: 125px; font-size: 14px; line-height: 18px; border: 1px solid #dddddd; padding: 10px;" placeholder="请填写特殊说明"></textarea>
          </div>
        </div>
      </div><!-- /.box-body -->
      <div class="box-footer text-center">
        <button type="button" id="form_loadblance_btn" onclick="do_form_loadbalance()" class="btn btn-info">提交申请</button>
      </div><!-- /.box-footer -->
    </form>
  </div><!-- /.box -->

  <div id="member_block" style="display:none">
    <div class="form-group">
      <label for="disk" class="col-sm-2 control-label">成员A</label>
      <div class="col-sm-6 input-group">
        <div class="input-group-unit">IP</div>
        <input type="text" class="form-control" name="address" placeholder="10">
        <div class="input-group-unit">PORT</div>
        <input type="text" class="form-control" name="port" placeholder="10">
        <div class="input-group-unit">
        <button class="btn btn-box-tool" onclick="$(this).parent().parent().parent().remove();loop-=1;set_member_tip()"><i class="fa fa-times"></i></button>
        </div>
      </div>
    </div>
  </div>
  
  <script type="text/javascript">
  var max_loop = {{ last_apply.loadbalance }};
  var loop = 0;
  var members = 0;
  function set_member_tip(){
    var remainder = max_loop - loop;
    $("#members_add_tip").html("还可以添加"+ remainder +"个成员")
  }
  function add_member(){
    if (loop >= max_loop){ 
      $("#members_add_tip").html("还可以添加0个成员")
      return false 
    };
    members += 1;
    loop += 1;
    set_member_tip()
    $("#member_block").find("label").text("成员"+members);
    var html = $("#member_block").html();
    $("#member_add_button").before(html)
  }
  function do_form_loadbalance(){
    var disks = $("#form_loadbalance").find("label[for=disk]");
    var params = [];
    for(var i in disks.toArray()){
      var loadbalance = {};
      var div = $(disks[i]).next();
      var address = $(div).find("input[name=address]").val();
      var port = $(div).find("input[name=port]").val();
      loadbalance["address"] = address;
      loadbalance["port"] = port;
      params.push(loadbalance);
    }
    $("#members").val(JSON.stringify(params))
    generate_ajax_post({
        form: "#form_loadbalance",
        btn: "#form_loadbalance_btn",
    })
  }
  </script>
