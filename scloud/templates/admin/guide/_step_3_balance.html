
{% import "admin/base/base_macros.html" as base %}
  <!-- Horizontal Form -->
  <div>
    <!-- form start -->
    <form id="form_loadbalance" data-pjax action="{{ reverse_url('apply.service.loadbalance.add' )}}?pro_id={{ pro_info_res.data.id }}&active=tab_2" class="form-horizontal" method="POST">
    {{ handler.xsrf_form_html() }}
    {% set applies = pro_info_res.data.pro_resource_applies %}
    {% if applies|length > 0 %}
      {% set last_apply = applies[-1] %}
    {% else %}
      {% set last_apply = None %}
    {% endif %}
    <input type="hidden" name="pro_id" value="{{ pro_info_res.data.id }}">
    {% if last_apply %}
    <input type="hidden" name="res_apply_id" value="{{ last_apply.id }}">
    {% endif %}
    {% set loadbalance_plot = loadbalance_res.data %}
      <div class="box-body">
        <!-- form input -->
        <input type="hidden" id="members" name="members" value="">
        <!--div class="form-group">
          <label for="disk" class="col-sm-2 control-label">成员A</label>
          <div class="col-sm-6 input-group">
            <div class="input-group-unit">IP</div>
            <input type="text" class="form-control" name="address" placeholder="10">
            <div class="input-group-unit">PORT</div>
            <input type="text" class="form-control" name="port" placeholder="10">
          </div>
        </div-->
        {% if last_apply %}
        {% set loadbalance = last_apply.loadbalance %}
        {% if loadbalance_plot %}
        {% set members = loadbalance_plot.as_dict().members %}
        {% set ST = STATUS_PRO_TABLES.get(loadbalance_plot.status) %}
        {{ base.tip_message(message="您{}的负载均衡内容{}，{}。".format(ST.act_value, ST.value, ST.todo_value), level=ST.level) }}
        {% else %}
        {% set members = [] %}
        {% endif %}
        {% for member in members %}
          {#{ member }#}
          {{ base.loadbalance_member(member, loop=loop.index, failures=member.failures, ERR=ERR) }}
        {% endfor %}
        <div class="form-group" id="member_add_button">
          <!-- button -->
          <label class="col-sm-2 control-label">
            <button type="button" onclick="add_member()" class="btn btn-info btn-sm"><i class="fa fa-plus"></i> 添加成员</button>
          </label>
          <div class="col-sm-6 input-group">
          <div class="input-group-unit" id="members_add_tip">还可以添加{{ loadbalance - members|length }}个成员</div>
          </div>
        </div>
        {% endif %}
        <!--div class="form-group">
          <label for="disk" class="col-sm-2 control-label">成员B</label>
          <div class="col-sm-6 input-group">
            <div class="input-group-unit">IP</div>
            <input type="text" class="form-control" id="disk" placeholder="10">
            <div class="input-group-unit">PORT</div>
            <input type="text" class="form-control" id="disk_backup" placeholder="10">
          </div>
        </div-->
        <div class="form-group">
          <label for="loadbalance" class="col-sm-2 control-label">策略</label>
          <div class="col-sm-6 input-group">
            <select class="form-control" name="plot">
            {% if loadbalance_plot %}
              {% set plot = loadbalance_plot.plot %}
            {% else %}
              {% set plot = -1 %}
            {% endif %}
              <option value="0"{% if plot|int == 0 %} selected="selected"{% endif %}>轮询</option>
              <option value="1"{% if plot|int == 1 %} selected="selected"{% endif %}>最小连接数</option>
              <option value="2"{% if plot|int == 2 %} selected="selected"{% endif %}>主从</option>
              <option value="9"{% if plot|int == 9 %} selected="selected"{% endif %}>其他</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="loadbalance" class="col-sm-2 control-label">健康检查</label>
          <div class="col-sm-6 input-group">
            <select class="form-control" name="health">
            {% if loadbalance_plot %}
              {% set health = loadbalance_plot.health %}
            {% else %}
              {% set health = -1 %}
            {% endif %}
              <option value="0"{% if health|int == 0 %} selected="selected"{% endif %}>HTTP</option>
              <option value="1"{% if health|int == 1 %} selected="selected"{% endif %}>TCP</option>
              <option value="2"{% if health|int == 2 %} selected="selected"{% endif %}>ICMP</option>
              <option value="9"{% if health|int == 9 %} selected="selected"{% endif %}>其他</option>
            </select>
            <div class="input-group-unit">
              URL:
            </div>
            <input type="text" class="form-control" id="url" name="url" placeholder="10" value="{{ loadbalance_plot.url }}">
            <div class="input-group-unit">
              关键字:
            </div>
            <input type="text" class="form-control" id="keyword" name="keyword" placeholder="10" value="{{ loadbalance_plot.keyword }}">
          </div>
        </div>
        <div class="form-group">
          <label for="desc" class="col-sm-2 control-label">特殊说明</label>
          <div class="col-sm-8 input-group">
            <textarea class="textarea" name="desc" style="width: 100%; height: 125px; font-size: 14px; line-height: 18px; border: 1px solid #dddddd; padding: 10px;" placeholder="请填写特殊说明">{{ loadbalance_plot.desc }}</textarea>
          </div>
        </div>
      </div><!-- /.box-body -->
      <div class="box-footer text-center">
        {% if not loadbalance_plot %}
        <button type="button" id="form_loadblance_btn" onclick="do_form_loadbalance()" class="btn btn-warning">提 交</button>
        {% elif loadbalance_plot.status <= STATUS_PRO_TABLES.REVOKED %}
        <button type="button" id="form_loadblance_btn" onclick="do_form_loadbalance()" class="btn btn-warning">提 交</button>
        {% elif loadbalance_plot.status == STATUS_PRO_TABLES.APPLIED %}
        <button type="button" id="form_loadblance_btn" onclick="javascript:;" class="btn btn-info">受理中</button>
        {% elif loadbalance_plot.status == STATUS_PRO_TABLES.CHECKED %}
        <button type="button" id="form_loadblance_btn" onclick="pro_table_do_confirm({_this: this, pro_table: 'pro_balance', ids: [{{ loadbalance_plot.id }}]})" class="btn btn-warning">确 认</button>
        {% elif loadbalance_plot.status == STATUS_PRO_TABLES.CONFIRMED %}
        <button type="button" id="form_loadblance_btn" onclick="javascript:;" class="btn btn-warning">已确认</button>
        <button type="button" id="form_loadblance_btn" onclick="do_form_loadbalance()" class="btn btn-warning">重 新 提 交</button>
        {% endif %}
      </div><!-- /.box-footer -->
    </form>
  </div><!-- /.box -->

  <div id="member_block" style="display:none">
    {{ base.loadbalance_member() }}
    {#
    <div class="form-group">
      <label for="disk" class="col-sm-2 control-label">成员A</label>
      <div class="col-sm-6 input-group">
        <div class="input-group-unit">IP</div>
        <input type="text" class="form-control" name="address" placeholder="10">
        <div class="input-group-unit">PORT</div>
        <input type="text" class="form-control" name="port" placeholder="10">
        <div class="input-group-unit">
        <button class="btn btn-box-tool" onclick="$(this).parent().parent().parent().remove();loop-=1;set_member_tip()"><i class="fa fa-times"></i></button>
        </div>
      </div>
    </div>
    #}
  </div>
  
  <script type="text/javascript">
  var max_loop = {{ last_apply.loadbalance - members|length }};
  var loop = 0;
  var members = 0;
  function set_member_tip(){
    var remainder = max_loop - loop;
    $("#members_add_tip").html("还可以添加"+ remainder +"个成员")
  }
  function add_member(){
    if (loop >= max_loop){ 
      $("#members_add_tip").html("还可以添加0个成员")
      return false 
    };
    members += 1;
    loop += 1;
    set_member_tip()
    $("#member_block").find("label").text("成员"+members);
    var html = $("#member_block").html();
    $("#member_add_button").before(html)
  }
  function do_form_loadbalance(){
    var disks = $("#form_loadbalance").find("label[for=disk]");
    var params = [];
    for(var i in disks.toArray()){
      var loadbalance = {};
      var div = $(disks[i]).next();
      var address = $(div).find("input[name=address]").val();
      var port = $(div).find("input[name=port]").val();
      loadbalance["address"] = address;
      loadbalance["port"] = port;
      params.push(loadbalance);
    }
    $("#members").val(JSON.stringify(params))
    generate_ajax_post({
        form: "#form_loadbalance",
        btn: "#form_loadbalance_btn",
    })
  }
  </script>
