<script type="text/javascript">
var comet_ws = null;
var connect_times = 0;
$(function(){
  init_comet_ws();
})
function init_comet_ws(){
  var wsServer = '{{ CONF("WS_HOST") }}{{ handler.reverse_url("ws.comet") }}'; //服务器地址
  comet_ws = new WebSocket(wsServer); //创建 WebSocket 对象
  // comet_ws.send("hello");//向服务器发送消息
  // console.log(comet_ws.readyState);//查看 comet_ws 当前状态
  comet_ws.onopen = function (evt) {
    //已经建立连接
    connect_times += 1;
    console.log("ws comet onopen");
    // comet_ws.send("hello world")
    var current_user_id = $("#head_current_user").attr("current_user_id");
    comet_ws.send(JSON.stringify({action:"online", user_id: current_user_id}))
  };
  comet_ws.onclose = function (evt) {
    //已经关闭连接
    console.log("ws comet onclose");
    init_comet_ws();
  };
  comet_ws.onmessage = function (evt) {
    console.log("ws comet onmessage");
    // console.log(evt.data)
    var response = JSON.parse(evt.data);

    // console.log(response.action)
    if (response.action == "online"){
      console.log("online_notice")
      if (connect_times == 1){
        online_notice(response);
      }
    }else if(response.action == "notice_user"){
      tasks_notice(response);
    }else if(response.action == "notice_checker"){
      tasks_notice(response);
    }
      //收到服务器消息，使用 evt.data 提取
  };
  comet_ws.onerror = function (evt) {
    console.log("ws comet onerror");
    // init_comet_ws();
    // comet_ws = new comet_ws(wsServer); //创建 comet_ws 对象
      //产生异常
  };
}
function send_message(){
  // console.log(comet_ws.readyState)
  if (comet_ws.readyState == 0){
    comet_ws.send("hello world");//向服务器发送消息
  }
}
function do_notice_user(res_ids){
  for(var i in res_ids){
    comet_ws.send(JSON.stringify({"action":"notice_user", "res_id": res_ids[i]}));
  }
  // send_init_message();
}
function do_notice_checker(){
  console.log("do_notice_checker")
  comet_ws.send(JSON.stringify({"action":"notice_checker"}));
  // send_init_message();
}
function online_notice(response){
  // console.log(response.html);
  var current_user_id = $("#head_current_user").attr("current_user_id");
  if (parseInt(response.user_id) != parseInt(current_user_id)){
    $("#alert_content").append(response.html)
  }
}
function tasks_notice(response){
  console.log("task_notice");
  console.log(response);
  $("#tasks-menu").html(response.html)
}
</script>
