<script type="text/javascript">
var websocket = null;
$(function(){
  init_ws();
})
function init_ws(){
  var wsServer = 'ws://127.0.0.1:9999{{ CONF("URL_ROOT") }}/ws/demo'; //服务器地址
  websocket = new WebSocket(wsServer); //创建 WebSocket 对象
  // websocket.send("hello");//向服务器发送消息
  // console.log(websocket.readyState);//查看 websocket 当前状态
  websocket.onopen = function (evt) {
    console.log("ws demo onopen");
    // websocket.send("hello world")
    {% if handler.current_user %}
    websocket.send(JSON.stringify({action:"join", user_id:'{{ handler.current_user.id }}'}))
    {% endif %}
      //已经建立连接
  };
  websocket.onclose = function (evt) {
    // console.log("onclose");
    websocket = new WebSocket(wsServer); //创建 WebSocket 对象
    //websocket.send(JSON.stringify({action:"offline", user_id:'{{ handler.current_user.id }}'}))
      //已经关闭连接
  };
  websocket.onmessage = function (evt) {
    // console.log("onmessage");
    // console.log(evt.data)
    var response = JSON.parse(evt.data);

    // console.log(response.action)
    if (response.action == "join"){
      console.log("online_notice")
      online_notice(response);
    }else if(response.action == "pro_resource_apply"){
      tasks_notice(response);
    }else if(response.action == "notice_checker"){
      tasks_notice(response);
    }
      //收到服务器消息，使用 evt.data 提取
  };
  websocket.onerror = function (evt) {
    console.log("onerror");
    websocket = new WebSocket(wsServer); //创建 WebSocket 对象
      //产生异常
  };
}
function send_message(){
  // console.log(websocket.readyState)
  if (websocket.readyState == 0){
    websocket.send("hello world");//向服务器发送消息
  }
}
function do_notice_user(res_ids){
  for(var i in res_ids){
    websocket.send(JSON.stringify({"action":"pro_resource_apply", "res_id": res_ids[i]}));
  }
  send_init_message();
}
function do_notice_checker(){
  console.log("do_notice_checker")
  websocket.send(JSON.stringify({"action":"notice_checker"}));
  send_init_message();
}
function online_notice(response){
  console.log(response.html);
  var current_user_id = $("#head_current_user").attr("current_user_id");
  if (parseInt(response.user_id) != parseInt(current_user_id)){
    $("#alert_content").append(response.html)
  }
}
function tasks_notice(response){
  // var current_user_id = $("#head_current_user").attr("current_user_id");
  console.log(response);
  $("#tasks-menu").html(response.html)
}
</script>
