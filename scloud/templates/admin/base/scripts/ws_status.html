<script type="text/javascript">
var ws_socket = null;
$(function(){
  init_ws_status();
})
function init_ws_status(){
  var wsServer = '{{ CONF("WS_HOST") }}/ws/status'; //服务器地址
  ws_socket = new WebSocket(wsServer); //创建 WebSocket 对象
  // ws_socket.send("hello");//向服务器发送消息
  ws_socket.onopen = function (evt) {
    console.log("onopen");
    // ws_socket.send("hello world")
    //已经建立连接
    send_init_message()
  };
  ws_socket.onclose = function (evt) {
    console.log("onclose");
    init_ws_status();
    // ws_socket = new WebSocket(wsServer); //创建 WebSocket 对象
    //ws_socket.send(JSON.stringify({action:"offline", user_id:'{{ handler.current_user.id }}'}))
      //已经关闭连接
  };
  ws_socket.onmessage = function (evt) {
    console.log("onmessage");
    console.log(evt.data)
    var response = JSON.parse(evt.data);

    console.log(response.action)
    if (response.action == "init_status"){
      console.log("init_status")
      init_task_status(response);
    }
      //收到服务器消息，使用 evt.data 提取
  };
  ws_socket.onerror = function (evt) {
    console.log("onerror");
    init_ws_status();
    // ws_socket = new WebSocket(wsServer); //创建 WebSocket 对象
      //产生异常
  };
}
function send_init_message(){
  var current_user_id = $("#head_current_user").attr("current_user_id")
  try{
    ws_socket.send(JSON.stringify({action: "init_status", user_id: current_user_id}))
  }catch(e){
  var wsServer = 'ws://127.0.0.1:9999/scloud/ws/status'; //服务器地址
  ws_socket = new WebSocket(wsServer); //创建 WebSocket 对象
  }
}
function init_task_status(response){
  // console.log(response);
  console.log(response.task_html)
  $("#tasks-menu").html(response.task_html)
}
</script>
